# =========================
# Store configuration
# =========================
stores:
  fs_local:
    kind: filesystem
    root: /content/drive/MyDrive/rag-kb-testdata

# =========================
# Input
# =========================
input:
  input_store: fs_local
  input_path: cleaned/documents.jsonl
  manifest_path: manifests/latest.jsonl

# =========================
# Outputs
# =========================
outputs:
  chunks:
    store: fs_local
    base: ce_out/chunks
    filename: chunks.jsonl
    dedup_filename: chunks.dedup.jsonl

  vector_index:
    store: fs_local
    base: ce_out/indexes/vector

  bm25_index:
    store: fs_local
    base: ce_out/indexes/bm25

# =========================
# Chunking
# =========================
chunking:
  window_chars: 1000
  overlap_chars: 120
  min_chunk_chars: 400
  pdf_max_tokens: 256

# =========================
# Processing (Deduplication)
# =========================
processing:
  dedup:
    exact_dedup:
      hash_field: chunk_text_hash

    semantic_dedup:
      enable: true

      # cosine similarity threshold
      threshold: 0.95

      # ANN recall candidates
      topk: 20

      # HNSW index parameters
      hnsw_m: 32
      ef_construction: 200
      ef_search: 128

      # normalize embeddings so that inner product == cosine
      normalize: true

# =========================
# Embedding (GPU + E5)
# =========================
embedding:
  model_name: "intfloat/e5-base-v2"
  device: "cuda"
  batch_size: 64
  normalize_embeddings: true

  instructions:
    passage: "passage: "
    query: "query: "

# =========================
# Indexing
# =========================
indexing:
  bm25:
    enabled: true

  vector:
    enabled: true
    faiss_index: "FlatIP" # FlatIP on normalized vectors ~= cosine similarity
